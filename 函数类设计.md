FFmpeg 壳加密视频播放器 Demo - 类设计
1. 核心类设计概览
text
┌─────────────────────────────────────────────────────────┐
│                  核心控制器与辅助类                     │
├─────────────────────────────────────────────────────────┤
│  VideoProcessor          KeyManager                    │
│  - 流程协调            - 密钥生成与管理              │
│  - 组件调度                                          │
└─────────────────────────────────────────────────────────┘
            │                            │
            ▼                            ▼
┌─────────────────────────┐  ┌─────────────────────────┐
│     加解密相关类        │  │     Metadata相关类      │
├─────────────────────────┤  ├─────────────────────────┤
│  Encryptor              │  │  MetadataHandler       │
│  Decryptor              │  │  - 配置文件解析        │
│  CryptoAlgorithmFactory │  │  - 元数据注入          │
│  AESEncryptor           │  │  MetadataValidator     │
│  Chacha20Encryptor      │  │  - 字段验证            │
└─────────────────────────┘  └─────────────────────────┘
            │                            │
            ▼                            ▼
┌─────────────────────────┐  ┌─────────────────────────┐
│     FFmpeg交互类        │  │      文件格式类         │
├─────────────────────────┤  ├─────────────────────────┤
│  FFmpegWrapper          │  │  EncryptedVideoFile    │
│  - FFmpeg命令封装       │  │  - 壳文件结构          │
│  StreamExtractor        │  │  FileHeader            │
│  - 流提取               │  │  - 文件头解析          │
└─────────────────────────┘  └─────────────────────────┘
            │
            ▼
┌─────────────────────────┐
│      播放器相关类       │
├─────────────────────────┤
│  VideoPlayer            │
│  - 播放控制             │
│  CLIInterface           │
│  - 命令行交互           │
│  PlatformAdapter        │
│  - 平台适配             │
└─────────────────────────┘
2. 类详细设计
2.1 VideoProcessor (视频处理器 - 主控制器)
职责: 协调整个加密/解密流程，调用各个组件完成工作

属性:

config: dict - 配置信息

encryptor: Encryptor - 加密器实例

decryptor: Decryptor - 解密器实例

metadata_handler: MetadataHandler - 元数据处理器

方法:

__init__(self, config_path: str = None)

参数: config_path - 配置文件路径

功能: 初始化所有组件，加载配置

encrypt_video(self, input_path: str, output_path: str, password: str, notice_video_path: str = None, metadata_config: str = None) -> bool

参数:

input_path: 原始视频路径

output_path: 输出加密文件路径

password: 加密密码

notice_video_path: 提示视频路径（可选）

metadata_config: 元数据配置路径（可选）

返回值: 成功/失败

功能: 执行完整加密流程

decrypt_and_play(self, encrypted_path: str, password: str, skip_notice: bool = False) -> bool

参数:

encrypted_path: 加密文件路径

password: 解密密码

skip_notice: 是否跳过提示段

返回值: 成功/失败

功能: 解密并播放视频

2.2 Encryptor (加密器)
职责: 视频加密核心逻辑

属性:

crypto_algorithm: BaseEncryptor - 加密算法实例

ffmpeg_wrapper: FFmpegWrapper - FFmpeg工具封装

key_manager: KeyManager - 密钥管理器

方法:

__init__(self, algorithm: str = "AES-CTR")

参数: algorithm - 加密算法名称

功能: 初始化加密算法

encrypt_stream(self, stream_data: bytes, password: str) -> tuple

参数:

stream_data: 视频流数据

password: 加密密码

返回值: (加密后的数据, IV/Nonce)

功能: 加密原始视频流

generate_encrypted_file(self, plain_video_path: str, notice_video_path: str, password: str, output_path: str) -> bool

参数:

plain_video_path: 原始视频路径

notice_video_path: 提示视频路径

password: 加密密码

output_path: 输出路径

返回值: 成功/失败

功能: 生成完整加密文件

2.3 Decryptor (解密器)
职责: 视频解密核心逻辑

属性:

crypto_algorithm: BaseEncryptor - 解密算法实例

key_manager: KeyManager - 密钥管理器

方法:

__init__(self, algorithm: str = "AES-CTR")

参数: algorithm - 解密算法名称

功能: 初始化解密算法

parse_file_header(self, file_path: str) -> dict

参数: file_path - 加密文件路径

返回值: 文件头信息字典

功能: 解析加密文件头

decrypt_stream(self, encrypted_data: bytes, password: str, iv_nonce: bytes = None) -> bytes

参数:

encrypted_data: 加密数据

password: 解密密码

iv_nonce: 初始化向量/Nonce

返回值: 解密后的数据

功能: 解密视频流

2.4 CryptoAlgorithmFactory (加密算法工厂)
职责: 创建和管理加密算法实例

方法:

create_algorithm(self, algorithm_name: str, **kwargs) -> BaseEncryptor

参数:

algorithm_name: 算法名称

kwargs: 算法特定参数

返回值: 加密算法实例

功能: 根据名称创建加密算法

get_available_algorithms(self) -> list

返回值: 可用算法列表

功能: 返回支持的加密算法

2.5 BaseEncryptor (加密算法基类 - 抽象类)
职责: 定义加密算法的统一接口

方法:

encrypt(self, data: bytes, key: bytes, **kwargs) -> tuple

参数:

data: 待加密数据

key: 加密密钥

kwargs: 算法特定参数

返回值: (加密数据, 额外参数如IV)

功能: 加密数据

decrypt(self, data: bytes, key: bytes, **kwargs) -> bytes

参数:

data: 待解密数据

key: 解密密钥

kwargs: 算法特定参数

返回值: 解密数据

功能: 解密数据

generate_key(self, password: str, salt: bytes = None) -> tuple

参数:

password: 密码

salt: 盐值

返回值: (密钥, salt)

功能: 从密码派生密钥

2.6 AESEncryptor (AES加密实现)
继承: BaseEncryptor

属性:

mode: str - 加密模式（CTR/CBC等）

key_size: int - 密钥长度

方法:

__init__(self, mode: str = "CTR", key_size: int = 256)

参数:

mode: 加密模式

key_size: 密钥长度

2.7 Chacha20Encryptor (Chacha20加密实现)
继承: BaseEncryptor

方法:

__init__(self, rounds: int = 20)

参数: rounds - 加密轮数

2.8 KeyManager (密钥管理器)
职责: 密钥的生成、存储和验证

属性:

key_derivation_func: str - 密钥派生函数

key_storage_path: str - 密钥存储路径

方法:

derive_key_from_password(self, password: str, salt: bytes = None, algorithm: str = "PBKDF2") -> tuple

参数:

password: 密码

salt: 盐值

algorithm: 派生算法

返回值: (密钥, salt)

功能: 从密码派生密钥

save_key_info(self, key_info: dict, file_path: str) -> bool

参数:

key_info: 密钥信息

file_path: 保存路径

返回值: 成功/失败

功能: 保存密钥信息（仅用于调试）

validate_password(self, password: str, stored_hash: bytes) -> bool

参数:

password: 待验证密码

stored_hash: 存储的哈希值

返回值: 验证结果

功能: 验证密码

2.9 MetadataHandler (元数据处理器)
职责: 处理视频元数据的读取、解析和注入

属性:

metadata_config: dict - 元数据配置

validator: MetadataValidator - 元数据验证器

方法:

__init__(self, config_path: str = None)

参数: config_path - 配置文件路径

parse_config_file(self, config_path: str) -> dict

参数: config_path - 配置文件路径

返回值: 解析后的配置字典

功能: 解析metadata.txt配置文件

inject_metadata(self, video_path: str, metadata: dict, output_path: str = None) -> bool

参数:

video_path: 视频文件路径

metadata: 元数据字典

output_path: 输出路径

返回值: 成功/失败

功能: 将元数据注入视频文件

generate_udta_json(self, metadata: dict) -> dict

参数: metadata - 原始元数据

返回值: 结构化udta JSON

功能: 生成用户数据盒子内容

2.10 MetadataValidator (元数据验证器)
职责: 验证元数据字段的合法性

属性:

whitelist: list - 白名单字段

field_patterns: dict - 字段格式模式

方法:

validate_field(self, key: str, value: str) -> tuple

参数:

key: 字段名

value: 字段值

返回值: (是否有效, 错误信息)

功能: 验证单个字段

sanitize_value(self, key: str, value: str) -> str

参数:

key: 字段名

value: 字段值

返回值: 净化后的值

功能: 清理字段值中的特殊字符

2.11 FFmpegWrapper (FFmpeg封装器)
职责: 封装FFmpeg命令行操作

属性:

ffmpeg_path: str - FFmpeg可执行文件路径

ffprobe_path: str - FFprobe可执行文件路径

方法:

extract_video_stream(self, input_path: str, output_path: str) -> bool

参数:

input_path: 输入视频路径

output_path: 输出裸流路径

返回值: 成功/失败

功能: 提取视频裸流

generate_notice_video(self, assets: dict, output_path: str) -> bool

参数:

assets: 素材字典

output_path: 输出路径

返回值: 成功/失败

功能: 生成提示视频

play_video(self, video_path: str, title: str = None) -> bool

参数:

video_path: 视频路径

title: 窗口标题

返回值: 成功/失败

功能: 播放视频

2.12 StreamExtractor (流提取器)
职责: 从视频文件中提取各种流

方法:

extract_all_streams(self, video_path: str) -> dict

参数: video_path - 视频路径

返回值: 流信息字典

功能: 提取所有流信息

demux_to_raw(self, video_path: str, stream_type: str, output_path: str) -> bool

参数:

video_path: 视频路径

stream_type: 流类型

output_path: 输出路径

返回值: 成功/失败

功能: 解复用为裸流

2.13 EncryptedVideoFile (加密视频文件)
职责: 表示加密视频文件的结构

属性:

file_path: str - 文件路径

header: FileHeader - 文件头

notice_section: bytes - 提示段数据

encrypted_data: bytes - 加密数据

方法:

__init__(self, file_path: str)

参数: file_path - 文件路径

load_file(self) -> bool

返回值: 成功/失败

功能: 加载并解析文件

save_file(self, output_path: str) -> bool

参数: output_path - 输出路径

返回值: 成功/失败

功能: 保存文件

2.14 FileHeader (文件头)
职责: 表示加密文件的文件头结构

属性:

magic: bytes - 魔数

version: int - 版本号

notice_length: int - 提示段长度

encryption_info: dict - 加密信息

方法:

from_bytes(self, data: bytes) -> bool

参数: data - 字节数据

返回值: 成功/失败

功能: 从字节解析文件头

to_bytes(self) -> bytes

返回值: 字节表示

功能: 转换为字节

2.15 VideoPlayer (视频播放器)
职责: 控制视频播放流程

属性:

ffmpeg_wrapper: FFmpegWrapper - FFmpeg封装

cli_interface: CLIInterface - 命令行接口

platform_adapter: PlatformAdapter - 平台适配器

方法:

__init__(self)

play_encrypted_video(self, file_path: str, password: str, skip_notice: bool = False) -> bool

参数:

file_path: 文件路径

password: 密码

skip_notice: 是否跳过提示

返回值: 成功/失败

功能: 播放加密视频

play_notice_section(self, notice_data: bytes) -> bool

参数: notice_data - 提示段数据

返回值: 成功/失败

功能: 播放提示段

2.16 CLIInterface (命令行接口)
职责: 提供命令行交互

方法:

prompt_for_password(self) -> str

返回值: 密码

功能: 提示输入密码

show_video_info(self, metadata: dict)

参数: metadata - 元数据

功能: 显示视频信息

ask_skip_notice(self) -> bool

返回值: 是否跳过提示

功能: 询问是否跳过提示段

show_progress(self, current: int, total: int, message: str = "")

参数:

current: 当前进度

total: 总进度

message: 进度信息

功能: 显示进度条

2.17 PlatformAdapter (平台适配器)
职责: 适配不同平台的特性

方法:

set_window_title(self, title: str) -> bool

参数: title - 窗口标题

返回值: 成功/失败

功能: 设置播放窗口标题

set_process_info(self, info: dict) -> bool

参数: info - 进程信息

返回值: 成功/失败

功能: 设置进程信息

get_platform_specific_ffmpeg_args(self) -> list

返回值: 平台特定的FFmpeg参数

功能: 获取平台相关参数

3. 配置类设计
3.1 ConfigManager (配置管理器)
职责: 管理应用程序配置

属性:

config_file: str - 配置文件路径

default_config: dict - 默认配置

方法:

__init__(self, config_file: str = "config.json")

load_config(self) -> dict

返回值: 配置字典

功能: 加载配置

save_config(self, config: dict) -> bool

参数: config - 配置字典

返回值: 成功/失败

功能: 保存配置

get_algorithm_config(self, algorithm_name: str) -> dict

参数: algorithm_name - 算法名称

返回值: 算法配置

功能: 获取算法特定配置

4. 错误处理类设计
4.1 VideoEncryptionError (视频加密错误)
继承: Exception

属性:

error_code: int - 错误代码

error_message: str - 错误信息

component: str - 出错组件

4.2 PasswordError (密码错误)
继承: VideoEncryptionError

属性:

remaining_attempts: int - 剩余尝试次数

4.3 FileFormatError (文件格式错误)
继承: VideoEncryptionError

属性:

expected_format: str - 期望格式

actual_format: str - 实际格式

5. 工具类设计
5.1 FileUtils (文件工具)
方法:

read_file_chunks(self, file_path: str, chunk_size: int = 8192) -> generator

参数:

file_path: 文件路径

chunk_size: 块大小

返回值: 数据块生成器

功能: 分块读取大文件

calculate_file_hash(self, file_path: str, algorithm: str = "sha256") -> str

参数:

file_path: 文件路径

algorithm: 哈希算法

返回值: 文件哈希值

功能: 计算文件哈希

5.2 VideoUtils (视频工具)
方法:

get_video_info(self, video_path: str) -> dict

参数: video_path - 视频路径

返回值: 视频信息字典

功能: 获取视频基本信息

validate_video_file(self, file_path: str) -> tuple

参数: file_path - 文件路径

返回值: (是否有效, 错误信息)

功能: 验证视频文件有效性

6. 类关系总结
VideoProcessor 作为主控制器，协调 Encryptor、Decryptor、MetadataHandler 工作

Encryptor 和 Decryptor 通过 CryptoAlgorithmFactory 获取具体算法实例

MetadataHandler 使用 MetadataValidator 验证元数据字段

FFmpegWrapper 和 StreamExtractor 处理FFmpeg相关操作

VideoPlayer 通过 CLIInterface 与用户交互，通过 PlatformAdapter 适配不同平台

EncryptedVideoFile 和 FileHeader 表示文件格式

ConfigManager 管理全局配置

所有组件通过 VideoEncryptionError 及其子类报告错误